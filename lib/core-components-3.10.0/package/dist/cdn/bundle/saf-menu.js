"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@saffron/config"),t=require("tslib"),s=require("@microsoft/fast-web-utilities"),n=require("./dom-helpers-DxoVHRyN.js"),i=require("./menu-item-CKI6Iyzn.js"),d=require("./global-enums-58U8enSy.js"),o=require("./fast-element-DOTfrYFb.js"),r=require("./slotted-cZBT0SIc.js");require("@floating-ui/dom"),require("./apply-mixins-CewQe2EQ.js"),require("./start-end-template-D7dQJgd3.js"),require("./ref-BeTe_0iT.js");class u extends o.FASTElement{constructor(){super(...arguments),this.expandedItem=null,this.focusIndex=-1,this.isNestedMenu=()=>{var e;return"menuitem"===(null===(e=this.parentElement)||void 0===e?void 0:e.role)},this.handleFocusOut=e=>{if(!this.contains(e.relatedTarget)&&void 0!==this.menuItems){this.collapseExpandedItem();const e=this.menuItems.findIndex(this.isFocusableElement);this.menuItems[this.focusIndex].setAttribute("tabindex","-1"),this.menuItems[e].setAttribute("tabindex","0"),this.focusIndex=e}},this.handleItemFocus=e=>{const t=e.target;void 0!==this.menuItems&&t!==this.menuItems[this.focusIndex]&&(this.menuItems[this.focusIndex].setAttribute("tabindex","-1"),this.focusIndex=this.menuItems.indexOf(t),t.setAttribute("tabindex","0"))},this.handleExpandedChanged=e=>{if(e.defaultPrevented||null===e.target||void 0===this.menuItems||this.menuItems.indexOf(e.target)<0)return;e.preventDefault();const t=e.target;null===this.expandedItem||t!==this.expandedItem||!1!==t.expanded?t.expanded&&(null!==this.expandedItem&&this.expandedItem!==t&&(this.expandedItem.expanded=!1),this.menuItems[this.focusIndex].setAttribute("tabindex","-1"),this.expandedItem=t,this.focusIndex=this.menuItems.indexOf(t),t.setAttribute("tabindex","0")):this.expandedItem=null},this.changeHandler=e=>{if(void 0===this.menuItems)return;const t=e.target,s=this.menuItems.indexOf(t);if(-1!==s&&"menuitemradio"===t.role&&!0===t.checked){for(let e=s-1;e>=0;--e){const t=this.menuItems[e],s=t.getAttribute("role");if(s===i.MenuItemRoleEnum.menuitemradio&&(t.checked=!1),"separator"===s)break}const e=this.menuItems.length-1;for(let t=s+1;t<=e;++t){const e=this.menuItems[t],s=e.getAttribute("role");if(s===i.MenuItemRoleEnum.menuitemradio&&(e.checked=!1),"separator"===s)break}}},this.isMenuItemElement=e=>e instanceof i.MenuItem||s.isHTMLElement(e)&&e.getAttribute("role")in u.focusableElementRoles,this.isFocusableElement=e=>this.isMenuItemElement(e),this.density=d.ComponentDensityEnum.inherit,this.hidden=!1}itemsChanged(e,t){this.$fastController.isConnected&&void 0!==this.menuItems&&(this.setItems(),o.Updates.enqueue(()=>this.setAriaOwns()))}connectedCallback(){super.connectedCallback(),o.Updates.enqueue(()=>{this.setItems()}),this.addEventListener("change",this.changeHandler),this.addEventListener("focusout",this.onFocusOut),this.id||(this.id=s.uniqueId("saf-menu-")),o.Updates.enqueue(()=>this.setAriaOwns())}disconnectedCallback(){super.disconnectedCallback(),this.removeItemListeners(),this.menuItems=void 0,this.removeEventListener("change",this.changeHandler),this.removeEventListener("focusout",this.onFocusOut)}focus(){this.setFocus(0,1)}collapseExpandedItem(){null!==this.expandedItem&&(this.expandedItem.expanded=!1,this.expandedItem=null)}handleMenuKeyDown(e){if(e.defaultPrevented||void 0===this.menuItems)return;const t=n.getRootActiveElement(this),i=this.menuItems.indexOf(t);switch(-1!==i&&(this.focusIndex=i),e.key){case s.keyArrowDown:return void this.setFocus(this.focusIndex+1,1);case s.keyArrowUp:return void this.setFocus(this.focusIndex-1,-1);case s.keyEnd:return void this.setFocus(this.menuItems.length-1,-1);case s.keyHome:return void this.setFocus(0,1);default:return!0}}removeItemListeners(e=this.items){e.forEach(e=>{e.removeEventListener("focus",this.handleItemFocus),e.removeEventListener("expanded-changed",this.handleExpandedChanged),o.Observable.getNotifier(e).unsubscribe(this,"hidden")})}setItems(){const e=Array.from(this.children);this.removeItemListeners(e),e.forEach(e=>o.Observable.getNotifier(e).subscribe(this,"hidden"));const t=e.filter(e=>!e.hasAttribute("hidden"));this.menuItems=t;const s=this.menuItems.filter(this.isMenuItemElement);s.length&&(this.focusIndex=0),s.forEach((e,t)=>{e.setAttribute("tabindex",0===t?"0":"-1"),e.addEventListener("expanded-change",this.handleExpandedChanged),e.addEventListener("focus",this.handleItemFocus)})}handleChange(e,t){"hidden"===t&&this.setItems()}setFocus(e,t){if(void 0!==this.menuItems)for(;e>=0&&e<this.menuItems.length;){const s=this.menuItems[e];if(this.isFocusableElement(s)){this.focusIndex>-1&&this.menuItems.length>=this.focusIndex-1&&this.menuItems[this.focusIndex].setAttribute("tabindex","-1"),this.focusIndex=e,s.setAttribute("tabindex","0"),s.focus();break}e+=t}}get hasSubmenus(){return this.submenus.length>0}get submenus(){return void 0===this.menuItems?[]:this.menuItems.reduce((e,t)=>(t instanceof i.MenuItem&&t.submenu instanceof u&&e.push(t.submenu),e),[])}onFocusOut(){setTimeout(()=>{this.contains(document.activeElement)||this.$emit("blur")},0)}setAriaOwns(){const e=this.submenus.reduce((e,t)=>(t.id&&e.push(t.id),e),[]);e.length&&this.setAttribute("aria-owns",e.join(" "))}}u.focusableElementRoles=i.MenuItemRoleEnum,t.__decorate([o.observable],u.prototype,"items",void 0),t.__decorate([o.attr],u.prototype,"density",void 0),t.__decorate([o.attr({mode:"boolean"})],u.prototype,"hidden",void 0);exports.default=()=>u.define({name:e.getComponentName("saf-menu"),template:o.html`
		<template
			slot="${e=>e.slot?e.slot:e.isNestedMenu()?"submenu":void 0}"
			role="menu"
			@keydown="${(e,t)=>e.handleMenuKeyDown(t.event)}"
			@focusout="${(e,t)=>e.handleFocusOut(t.event)}"
		>
			<slot ${r.slotted("items")}></slot>
		</template>
	`,styles:o.css`
	${e.replaceComponentNamesWithSafAttribute(':host{background-color:var(--saf-color-background-default);border:var(--saf-line-width-thin) solid var(--saf-color-border-stronger);border-radius:var(--saf-border-radius-sm);box-shadow:var(--saf-drop-shadow-level-2);display:inline-block;overflow-y:auto;overscroll-behavior:contain;padding:4px;max-height:calc(280px*(1 - var(--saf-density))*(2 - var(--saf-density))*.5 + 224px*var(--saf-density)*(2 - var(--saf-density)))}:host([density=standard]){--saf-density: 0}:host([density=compact]){--saf-density: 1}:host([density=""]){--saf-density: 2}:host([slot=submenu]){margin-left:3px;margin-top:-5px;min-width:max-content;position:absolute}:host ::slotted(saf-divider){margin:var(--saf-spacing-1) 0}:host([hidden]){display:none}')}
`,registry:e.getRegistry()});
