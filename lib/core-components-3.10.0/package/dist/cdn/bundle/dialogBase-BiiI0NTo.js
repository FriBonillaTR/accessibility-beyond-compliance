"use strict";var e=require("tslib"),t=require("@microsoft/fast-web-utilities"),i=require("tabbable"),s=require("./logger-vjs750p7.js"),n=require("./fast-element-DOTfrYFb.js");class o extends n.FASTElement{constructor(){super(...arguments),this.inactive=!1,this.isTrappingFocus=!1,this.depth=0,this.handleDocumentKeydown=e=>{if(!e.defaultPrevented&&!this.isHidden&&0===this.depth)switch(e.key){case t.keyEscape:this.dismiss(),e.preventDefault();break;case t.keyTab:this.handleTabKeyDown(e)}}}dismiss(){this.$emit("dismiss",null,{bubbles:!1}),this.hasCancelEvent&&this.$emit("cancel",null,{bubbles:!1}),this.hide()}_show(){this.style.setProperty("z-index","var(--saf-z-index-dialog)"),this.isHidden=!1}_hide(){this.isHidden=!0,this.depth=0,this.inactive=!1,this.hasCancelEvent&&this.$emit("close",null,{bubbles:!1}),setTimeout(()=>{this.style.removeProperty("z-index")},200)}scrollHandler(){this.$emit("scroll")}focusTriggerId(){const e=document.getElementById(this.triggerId);if(!e){const e=this.localName;return void s.Logger.error(`${e}: Failed to focus the trigger element. The triggerId '${this.triggerId}' does not match any element on the page. Please ensure that the triggerId is correct.`)}e.focus()}connectedCallback(){super.connectedCallback(),this.initialize&&setTimeout(()=>{this.initialize()}),document.addEventListener(this.openEventName,e=>{this.handleShow(e)}),document.addEventListener(this.hideEventName,e=>{this.handleHide(e)}),document.addEventListener("keydown",e=>{this.handleDocumentKeydown(e)}),this.notifier=n.Observable.getNotifier(this),this.notifier.subscribe(this,this.hideStateAttribute),this.updateTrapFocus(),!this.isHidden&&this.isModal&&this.$emit(this.openEventName,null)}disconnectedCallback(){super.disconnectedCallback(),this.destroy&&setTimeout(()=>{this.destroy()}),document.removeEventListener(this.openEventName,e=>{this.handleShow(e)}),document.removeEventListener(this.hideEventName,e=>{this.handleHide(e)}),document.removeEventListener("keydown",e=>{this.handleDocumentKeydown(e)}),this.updateTrapFocus(!1),this.notifier.unsubscribe(this,this.hideStateAttribute),!this.isHidden&&this.isModal&&this.$emit(this.hideEventName,null)}handleChange(e,t){if(t===this.hideStateAttribute)this.updateTrapFocus(),this.isHidden?this.$emit(this.hideEventName,null):this.$emit(this.openEventName,null),this.isHidden&&this.triggerId&&this.isModal&&!this.preventTriggerFocus&&this.focusTriggerId()}handleShow(e){this.isHidden||e.target===this||(this.isModal&&!this.contains(e.target)&&(this.inactive=!0),this.depth++)}handleHide(e){e.target!==this&&this.depth&&(this.depth--,0===this.depth&&(this.inactive=!1,!this.isTrappingFocus||this.isHidden||e.target.triggerId||this.focusFirstElement()))}handleDocumentFocus(e){!e.defaultPrevented&&this.shouldForceFocus(e.target)&&(this.focusFirstElement(),e.preventDefault())}handleTabKeyDown(e){var t,i;if(this.noFocusTrap||this.isHidden)return;const s=this.getTabQueueBounds();if(0===s.length)return;if(1===s.length)return s[0].focus(),void e.preventDefault();const n=null===(i=null===(t=e.target)||void 0===t?void 0:t.shadowRoot)||void 0===i?void 0:i.activeElement;!e.shiftKey||e.target!==s[0]&&n!==s[0]?e.shiftKey||e.target!==s[s.length-1]&&n!==s[s.length-1]||(s[0].focus(),e.preventDefault()):(s[s.length-1].focus(),e.preventDefault())}getTabQueueBounds(){const e=o.reduceTabbableItems([],this);return this.closeButtonElement instanceof HTMLElement&&e.unshift(this.closeButtonElement),e}focusFirstElement(){const e=this.getTabQueueBounds();this.titleElement instanceof HTMLElement?this.titleElement.focus():e.length>0?e[0].focus():this.dialog instanceof HTMLElement&&this.dialog.focus()}shouldForceFocus(e){return this.isTrappingFocus&&!this.contains(e)&&0===this.depth}shouldTrapFocus(){return!this.noFocusTrap&&!this.isHidden}updateTrapFocus(e){const t=void 0===e?this.shouldTrapFocus():e;t&&!this.isTrappingFocus?(this.isTrappingFocus=!0,document.addEventListener("focusin",e=>{this.handleDocumentFocus(e)}),n.Updates.enqueue(()=>{this.shouldForceFocus(document.activeElement)&&this.focusFirstElement()})):!t&&this.isTrappingFocus&&(this.isTrappingFocus=!1,document.removeEventListener("focusin",e=>{this.handleDocumentFocus(e)}))}static reduceTabbableItems(e,t){var s;return"-1"===t.getAttribute("tabindex")||t.hidden||((i.isTabbable(t)||o.isFocusableFastElement(t))&&e.push(t),t.childElementCount&&Array.from(t.children).forEach(t=>{e=o.reduceTabbableItems(e,t)}),(null===(s=t.shadowRoot)||void 0===s?void 0:s.childElementCount)&&Array.from(t.shadowRoot.children).forEach(t=>{e=o.reduceTabbableItems(e,t)})),e}static isFocusableFastElement(e){var t,i;return!!(null===(i=null===(t=e.$fastController)||void 0===t?void 0:t.definition.shadowOptions)||void 0===i?void 0:i.delegatesFocus)&&!e.hasAttribute("disabled")}}e.__decorate([n.attr({attribute:"aria-describedby"})],o.prototype,"ariaDescribedby",void 0),e.__decorate([n.attr({attribute:"aria-labelledby"})],o.prototype,"ariaLabelledby",void 0),e.__decorate([n.attr({attribute:"aria-label"})],o.prototype,"ariaLabel",void 0),e.__decorate([n.attr({attribute:"trigger-id"})],o.prototype,"triggerId",void 0),e.__decorate([n.attr({mode:"boolean"})],o.prototype,"inactive",void 0),exports.DialogBase=o;
