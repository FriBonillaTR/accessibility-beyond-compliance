"use strict";var e=require("tslib"),t=require("@microsoft/fast-web-utilities"),i=require("./option-3u3pMIm5.js"),s=require("./dom-helpers-DxoVHRyN.js"),o=require("./apply-mixins-CewQe2EQ.js"),n=require("./aria-global-CYzDgx1a.js"),d=require("./fast-element-DOTfrYFb.js"),l=require("./global-enums-58U8enSy.js");class h extends d.FASTElement{constructor(){super(...arguments),this._options=[],this.selectedIndex=-1,this.selectedOptions=[],this.shouldSkipFocus=!1,this.typeaheadBuffer="",this.typeaheadExpired=!0,this.typeaheadTimeout=-1}get firstSelectedOption(){var e;return null!==(e=this.selectedOptions[0])&&void 0!==e?e:null}get hasSelectableOptions(){return this.options.length>0&&!this.options.every(e=>e.disabled)}get length(){var e,t;return null!==(t=null===(e=this.options)||void 0===e?void 0:e.length)&&void 0!==t?t:0}get options(){return d.Observable.track(this,"options"),this._options}set options(e){this._options=e,d.Observable.notify(this,"options")}get typeAheadExpired(){return this.typeaheadExpired}set typeAheadExpired(e){this.typeaheadExpired=e}static slottedOptionFilter(e){return i.isListboxOption(e)&&!e.hidden}clickHandler(e){const t=e.target.closest("option,[role=option]");if(t&&!t.disabled)return this.selectedIndex=this.options.indexOf(t),!0}focusAndScrollOptionIntoView(e=this.firstSelectedOption){this.contains(s.getRootActiveElement(this))&&null!==e&&(e.focus(),requestAnimationFrame(()=>{e.scrollIntoView({block:"nearest"})}))}focusinHandler(e){this.shouldSkipFocus||e.target!==e.currentTarget||(this.setSelectedOptions(),this.focusAndScrollOptionIntoView()),this.shouldSkipFocus=!1}getTypeaheadMatches(){const e=this.typeaheadBuffer.replace(/[.*+\-?^${}()|[\]\\]/g,"\\$&"),t=new RegExp(`^${e}`,"gi");return this.options.filter(e=>e.text.trim().match(t))}getSelectableIndex(e=this.selectedIndex,t){const i=e>t?-1:e<t?1:0,s=e+i;let o=null;switch(i){case-1:o=this.options.reduceRight((e,t,i)=>!e&&!t.disabled&&i<s?t:e,o);break;case 1:o=this.options.reduce((e,t,i)=>!e&&!t.disabled&&i>s?t:e,o)}return this.options.indexOf(o)}handleChange(e,t){if("selected"===t)h.slottedOptionFilter(e)&&(this.selectedIndex=this.options.indexOf(e)),this.setSelectedOptions()}handleTypeAhead(e){this.typeaheadTimeout&&window.clearTimeout(this.typeaheadTimeout),this.typeaheadTimeout=window.setTimeout(()=>this.typeaheadExpired=!0,h.TYPE_AHEAD_TIMEOUT_MS),e.length>1||(this.typeaheadBuffer=`${this.typeaheadExpired?"":this.typeaheadBuffer}${e}`)}keydownHandler(e){if(this.disabled)return!0;this.shouldSkipFocus=!1;const i=e.key;switch(i){case t.keyHome:e.shiftKey||(e.preventDefault(),this.selectFirstOption());break;case t.keyArrowDown:e.shiftKey||(e.preventDefault(),this.selectNextOption());break;case t.keyArrowUp:e.shiftKey||(e.preventDefault(),this.selectPreviousOption());break;case t.keyEnd:e.preventDefault(),this.selectLastOption();break;case t.keyTab:return this.focusAndScrollOptionIntoView(),!0;case t.keyEnter:case t.keyEscape:return!0;case t.keySpace:if(this.typeaheadExpired)return!0;default:return 1===i.length&&this.handleTypeAhead(`${i}`),!0}}mousedownHandler(e){return this.shouldSkipFocus=!this.contains(s.getRootActiveElement(this)),!0}multipleChanged(e,t){this.ariaMultiSelectable=t?"true":null}selectedIndexChanged(e,t){var i;if(this.hasSelectableOptions){if((null===(i=this.options[this.selectedIndex])||void 0===i?void 0:i.disabled)&&"number"==typeof e){const i=this.getSelectableIndex(e,t),s=i>-1?i:e;return this.selectedIndex=s,void(t===s&&this.selectedIndexChanged(t,s))}this.setSelectedOptions()}else this.selectedIndex=-1}selectedOptionsChanged(e,t){var i;const s=t.filter(h.slottedOptionFilter);null===(i=this.options)||void 0===i||i.forEach(e=>{const t=d.Observable.getNotifier(e);t.unsubscribe(this,"selected"),e.selected=s.includes(e),t.subscribe(this,"selected")})}selectFirstOption(){var e,t;this.disabled||(this.selectedIndex=null!==(t=null===(e=this.options)||void 0===e?void 0:e.findIndex(e=>!e.disabled))&&void 0!==t?t:-1)}selectLastOption(){this.disabled||(this.selectedIndex=t.findLastIndex(this.options,e=>!e.disabled))}selectNextOption(){!this.disabled&&this.selectedIndex<this.options.length-1&&(this.selectedIndex+=1)}selectPreviousOption(){!this.disabled&&this.selectedIndex>0&&(this.selectedIndex=this.selectedIndex-1)}setDefaultSelectedOption(){var e,t;this.selectedIndex=null!==(t=null===(e=this.options)||void 0===e?void 0:e.findIndex(e=>e.defaultSelected))&&void 0!==t?t:-1}setSelectedOptions(){var e,t,i;(null===(e=this.options)||void 0===e?void 0:e.length)&&(this.selectedOptions=[this.options[this.selectedIndex]],this.ariaActiveDescendant=null!==(i=null===(t=this.firstSelectedOption)||void 0===t?void 0:t.id)&&void 0!==i?i:"",this.focusAndScrollOptionIntoView())}slottedOptionsChanged(e,s){this.options=s.reduce((e,t)=>(i.isListboxOption(t)&&e.push(t),e),[]);const o=`${this.options.length}`;this.options.forEach((e,i)=>{e.id||(e.id=t.uniqueId("option-")),e.ariaPosInSet=`${i+1}`,e.ariaSetSize=o}),this.$fastController.isConnected&&(this.setSelectedOptions(),this.setDefaultSelectedOption())}typeaheadBufferChanged(e,t){if(this.$fastController.isConnected){const e=this.getTypeaheadMatches();if(e.length){const t=this.options.indexOf(e[0]);t>-1&&(this.selectedIndex=t)}this.typeaheadExpired=!1}}}h.TYPE_AHEAD_TIMEOUT_MS=1e3,e.__decorate([d.attr({mode:"boolean"})],h.prototype,"disabled",void 0),e.__decorate([d.observable],h.prototype,"selectedIndex",void 0),e.__decorate([d.observable],h.prototype,"selectedOptions",void 0),e.__decorate([d.observable],h.prototype,"slottedOptions",void 0),e.__decorate([d.observable],h.prototype,"typeaheadBuffer",void 0);class r{}e.__decorate([d.observable],r.prototype,"ariaActiveDescendant",void 0),e.__decorate([d.observable],r.prototype,"ariaDisabled",void 0),e.__decorate([d.observable],r.prototype,"ariaExpanded",void 0),e.__decorate([d.observable],r.prototype,"ariaMultiSelectable",void 0),o.applyMixins(r,n.ARIAGlobalStatesAndProperties),o.applyMixins(h,r);class a extends h{constructor(){super(...arguments),this.activeIndex=-1,this.rangeStartIndex=-1,this.density=l.ComponentDensityEnum.inherit}get activeOption(){return this.options[this.activeIndex]}get checkedOptions(){var e;return null===(e=this.options)||void 0===e?void 0:e.filter(e=>e.checked)}get firstSelectedOptionIndex(){return this.options.indexOf(this.firstSelectedOption)}activeIndexChanged(e,t){var i,s;this.ariaActiveDescendant=null!==(s=null===(i=this.options[t])||void 0===i?void 0:i.id)&&void 0!==s?s:"",this.focusAndScrollOptionIntoView()}checkActiveIndex(){if(!this.multiple)return;const e=this.activeOption;e&&(e.checked=!0)}checkFirstOption(e=!1){e?(-1===this.rangeStartIndex&&(this.rangeStartIndex=this.activeIndex+1),this.options.forEach((e,i)=>{e.checked=t.inRange(i,this.rangeStartIndex)})):this.uncheckAllOptions(),this.activeIndex=0,this.checkActiveIndex()}checkLastOption(e=!1){e?(-1===this.rangeStartIndex&&(this.rangeStartIndex=this.activeIndex),this.options.forEach((e,i)=>{e.checked=t.inRange(i,this.rangeStartIndex,this.options.length)})):this.uncheckAllOptions(),this.activeIndex=this.options.length-1,this.checkActiveIndex()}connectedCallback(){super.connectedCallback(),this.addEventListener("focusout",this.focusoutHandler)}disconnectedCallback(){this.removeEventListener("focusout",this.focusoutHandler),super.disconnectedCallback()}checkNextOption(e=!1){e?(-1===this.rangeStartIndex&&(this.rangeStartIndex=this.activeIndex),this.options.forEach((e,i)=>{e.checked=t.inRange(i,this.rangeStartIndex,this.activeIndex+1)})):this.uncheckAllOptions(),this.activeIndex+=this.activeIndex<this.options.length-1?1:0,this.checkActiveIndex()}checkPreviousOption(e=!1){e?(-1===this.rangeStartIndex&&(this.rangeStartIndex=this.activeIndex),1===this.checkedOptions.length&&(this.rangeStartIndex+=1),this.options.forEach((e,i)=>{e.checked=t.inRange(i,this.activeIndex,this.rangeStartIndex)})):this.uncheckAllOptions(),this.activeIndex-=this.activeIndex>0?1:0,this.checkActiveIndex()}clickHandler(e){var t;if(!this.multiple)return super.clickHandler(e);const i=null===(t=e.target)||void 0===t?void 0:t.closest("[role=option]");return i&&!i.disabled?(this.uncheckAllOptions(),this.activeIndex=this.options.indexOf(i),this.checkActiveIndex(),this.toggleSelectedForAllCheckedOptions(),!0):void 0}focusAndScrollOptionIntoView(){super.focusAndScrollOptionIntoView(this.activeOption)}focusinHandler(e){if(!this.multiple)return super.focusinHandler(e);this.shouldSkipFocus||e.target!==e.currentTarget||(this.uncheckAllOptions(),-1===this.activeIndex&&(this.activeIndex=-1!==this.firstSelectedOptionIndex?this.firstSelectedOptionIndex:0),this.checkActiveIndex(),this.setSelectedOptions(),this.focusAndScrollOptionIntoView()),this.shouldSkipFocus=!1}focusoutHandler(e){this.multiple&&this.uncheckAllOptions()}keydownHandler(e){if(!this.multiple)return super.keydownHandler(e);if(this.disabled)return!0;const{key:i,shiftKey:s}=e;switch(this.shouldSkipFocus=!1,i){case t.keyHome:return void this.checkFirstOption(s);case t.keyArrowDown:return void this.checkNextOption(s);case t.keyArrowUp:return void this.checkPreviousOption(s);case t.keyEnd:return void this.checkLastOption(s);case t.keyTab:return this.focusAndScrollOptionIntoView(),!0;case t.keyEscape:return this.uncheckAllOptions(),this.checkActiveIndex(),!0;case t.keySpace:if(e.preventDefault(),this.typeAheadExpired)return void this.toggleSelectedForAllCheckedOptions();default:return 1===i.length&&this.handleTypeAhead(`${i}`),!0}}mousedownHandler(e){if(e.offsetX>=0&&e.offsetX<=this.scrollWidth)return super.mousedownHandler(e)}multipleChanged(e,t){var i;this.ariaMultiSelectable=t?"true":null,null===(i=this.options)||void 0===i||i.forEach(e=>{e.checked=!t&&void 0}),this.setSelectedOptions()}setSelectedOptions(){this.multiple?this.$fastController.isConnected&&this.options&&(this.selectedOptions=this.options.filter(e=>e.selected),this.focusAndScrollOptionIntoView()):super.setSelectedOptions()}sizeChanged(e,t){var i;const s=Math.max(0,parseInt(null!==(i=null==t?void 0:t.toFixed())&&void 0!==i?i:"",10));s!==t&&d.Updates.enqueue(()=>{this.size=s}),this.updateComputedStylesheet()}toggleSelectedForAllCheckedOptions(){const e=this.checkedOptions.filter(e=>!e.disabled),t=!e.every(e=>e.selected);e.forEach(e=>e.selected=t),this.selectedIndex=this.options.indexOf(e[e.length-1]),this.setSelectedOptions()}typeaheadBufferChanged(e,t){if(this.multiple){if(this.$fastController.isConnected){const e=this.getTypeaheadMatches(),t=this.options.indexOf(e[0]);t>-1&&(this.activeIndex=t,this.uncheckAllOptions(),this.checkActiveIndex()),this.typeAheadExpired=!1}}else super.typeaheadBufferChanged(e,t)}uncheckAllOptions(e=!1){this.options.forEach(e=>e.checked=!this.multiple&&void 0),e||(this.rangeStartIndex=-1)}get options(){return d.Observable.track(this,"options"),this._options}set options(e){this._options=e,d.Observable.notify(this,"options")}slottedOptionsChanged(e,s){this.options=s.reduce((e,t)=>(i.isListboxOption(t)&&e.push(t),e),[]);const o=`${this.options.length}`;this.options.forEach((e,i)=>{e.id||(e.id=t.uniqueId("option-")),e.ariaPosInSet=`${i+1}`,e.ariaSetSize=o,e.isMultiple=this.multiple}),this.$fastController.isConnected&&(this.setSelectedOptions(),this.setDefaultSelectedOption())}updateComputedStylesheet(){this.computedStylesheet&&this.$fastController.removeStyles(this.computedStylesheet);const e=`${this.size}`;this.computedStylesheet=d.css`
			:host {
				--saf-listbox-size: ${e};
			}
		`,this.$fastController.addStyles(this.computedStylesheet)}}e.__decorate([d.observable],a.prototype,"activeIndex",void 0),e.__decorate([d.attr({mode:"boolean"})],a.prototype,"multiple",void 0),e.__decorate([d.attr({converter:d.nullableNumberConverter})],a.prototype,"size",void 0),e.__decorate([d.attr({attribute:"aria-labelledby"})],a.prototype,"ariaLabelledBy",void 0),e.__decorate([d.attr({attribute:"aria-label"})],a.prototype,"ariaLabel",void 0),e.__decorate([d.attr],a.prototype,"density",void 0),exports.DelegatesARIAListbox=r,exports.Listbox=a;
